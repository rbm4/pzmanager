name: Deploy to Production

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Resolve expected version
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Expected version after deployment: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Trigger server restart
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
          RESTART_PASSWORD: ${{ secrets.RESTART_PASSWORD }}
        run: |
          echo "Triggering restart on production server..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SERVER_URL}/api/system/restart" \
            -H "Content-Type: application/json" \
            -d "{\"password\": \"${RESTART_PASSWORD}\"}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Restart triggered successfully!"
          else
            echo "‚ùå Restart failed with status $HTTP_CODE"
            exit 1
          fi
      
      - name: Wait for server to restart
        run: |
          echo "Waiting 60 seconds for server to restart and download new artifact..."
          sleep 60
      
      - name: Verify deployment
        id: verify
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
        run: |
          EXPECTED_VERSION="${{ steps.version.outputs.tag }}"
          echo "Expected version: $EXPECTED_VERSION"
          
          for i in {1..10}; do
            RESPONSE=$(curl -s -f "${SERVER_URL}/api/system/health" 2>/dev/null)
            if [ $? -eq 0 ]; then
              echo "Health response: $RESPONSE"
              
              # Parse version from JSON response
              RUNNING_VERSION=$(echo "$RESPONSE" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
              echo "Running version: $RUNNING_VERSION"
              
              if [ "$RUNNING_VERSION" = "$EXPECTED_VERSION" ]; then
                echo "‚úÖ Server is running the expected version ($EXPECTED_VERSION)"
                echo "status=deployed" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "‚ö†Ô∏è Server is UP but running version $RUNNING_VERSION (expected $EXPECTED_VERSION)"
                echo "‚ö†Ô∏è The deployment likely failed and was rolled back by the server"
                echo "status=rolled-back" >> $GITHUB_OUTPUT
                echo "running_version=$RUNNING_VERSION" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            echo "Attempt $i/10: Server not ready yet..."
            sleep 5
          done
          
          echo "‚ùå Server health check failed after 10 attempts"
          echo "status=unreachable" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Notify deployment status
        if: always()
        run: |
          STATUS="${{ steps.verify.outputs.status }}"
          
          if [ "$STATUS" = "deployed" ]; then
            echo "üöÄ Deployment of ${{ steps.version.outputs.tag }} completed successfully!"
          elif [ "$STATUS" = "rolled-back" ]; then
            echo "‚ö†Ô∏è Deployment of ${{ steps.version.outputs.tag }} FAILED ‚Äî server rolled back to ${{ steps.verify.outputs.running_version }}"
            echo "::warning::Deployment failed. Server automatically rolled back to version ${{ steps.verify.outputs.running_version }}"
          else
            echo "‚ùå Deployment verification failed ‚Äî server unreachable"
          fi
